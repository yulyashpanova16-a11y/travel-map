<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Моя карта путешествий</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; }
    #map { height: 100vh; width: 100vw; }
    #sidebar {
      position: absolute;
      top: 12px; left: 12px; background: #fff8; padding: 10px 16px;
      border-radius: 8px; z-index: 1001; max-width: 260px; box-shadow: 0 4px 16px #0003;
    }
    #sidebar h4 { margin:0 0 12px;font-size:1.18em; }
    #sidebar ul { margin:0;padding:0;list-style: none;}
    #sidebar li {
      margin: 0 0 5px; cursor:pointer; border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
    }
    #legend { position:absolute; bottom:14px; left:16px; background:#fff9; border-radius:8px; padding:6px 16px; z-index:1001; font-size:0.95em;}
    .leaflet-popup-content img { max-width:200px; border-radius: 8px;}
    @media (max-width:600px){
      #sidebar { max-width: 96vw; position:static; }
    }
  </style>
</head>
<body>
<div id="sidebar">
  <h4>Посетила:</h4>
  <ul id="placesList"></ul>
  <button onclick="locateMe()">Где я?</button>
</div>
<div id="map"></div>
<div id="legend"> <strong>Маршрут:</strong> <span style="color:purple">Фиолетовая линия</span></div>

<!-- Leaflet scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
const map = L.map('map').setView([48.8566, 2.3522], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

// --- Кастомные иконки по эмоции ---
const icons = {
  happy:  L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers/img/marker-icon-2x-green.png", iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34] }),
  relax:  L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers/img/marker-icon-2x-blue.png", iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34] }),
  dream:  L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers/img/marker-icon-2x-violet.png", iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34] }),
  default:L.icon({ iconUrl: "https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers/img/marker-icon-2x-grey.png", iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34] })
};

const places = [
  {
    city: "Париж",
    coords: [48.8566, 2.3522],
    photo: "https://images.unsplash.com/photo-1502602898657-3e91760cbb34?auto=format&fit=crop&w=800&q=80",
    note: "Много ходила и много чувствовала.",
    mood: "happy"
  },
  {
    city: "Рим",
    coords: [41.9028, 12.4964],
    photo: "https://images.unsplash.com/photo-1529260830199-42c24126f198?auto=format&fit=crop&w=800&q=80",
    note: "Ела пасту и никуда не спешила.",
    mood: "relax"
  },
  {
    city: "Берлин",
    coords: [52.52, 13.405],
    photo: "https://images.unsplash.com/photo-1432839318976-bacd0e8bdfd6?auto=format&fit=crop&w=800&q=80",
    note: "Современность и дух свободы.",
    mood: "dream"
  }
];

const markers = L.markerClusterGroup();
const markersArray = [];

places.forEach((place, i) => {
  const marker = L.marker(place.coords, {
    icon: icons[place.mood] || icons.default,
    title: place.city
  }).bindPopup(`
    <h3>${place.city}</h3>
    <img src="${place.photo}" style="width:100%;max-width:200px;" />
    <p>${place.note}</p>
  `);

  markersArray.push(marker);
  markers.addLayer(marker);
});
map.addLayer(markers);

// --- Список мест --- //
const placesList = document.getElementById('placesList');
places.forEach((place, i) => {
  const li = document.createElement('li');
  li.textContent = place.city;
  li.onclick = function() {
    map.setView(place.coords, 10, {animate:true});
    markersArray[i].openPopup();
  };
  placesList.appendChild(li);
});

// --- Маршрут --- //
const route = places.map(p=>p.coords);
L.polyline(route, {
  color: 'purple',
  weight: 3,
  opacity: 0.8
}).addTo(map);

// --- Геолокация кнопка --- //
window.locateMe = function() {
  map.locate({setView: true, maxZoom: 10});
};
map.on('locationfound', e => {
  L.circle(e.latlng, {radius:700, color:'green'}).addTo(map)
    .bindPopup("Вы здесь!").openPopup();
});
map.on('locationerror', e => {
  alert("Геолокация не сработала: " + e.message);
});
</script>
</body>
</html>
